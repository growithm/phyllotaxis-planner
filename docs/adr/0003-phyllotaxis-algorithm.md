# ADR-0003: フィロタキシスアルゴリズム実装の決定

## ステータス

承認済み

## コンテキスト

Phyllotaxis Plannerの核となる機能として、アイデアノードの配置アルゴリズムの選択が必要でした。以下の要件を満たす必要がありました：

- 視覚的に美しく自然な配置
- アイデア間の重複を避ける効率的な配置
- 新しいアイデア追加時の既存配置への影響最小化
- 数学的な一貫性と予測可能性
- 計算コストの最適化
- スケーラビリティ（50個程度のアイデアに対応）

## 決定

黄金角（137.5077640500378度）を使用したフィロタキシス螺旋配置アルゴリズムを採用することを決定しました。

## 理由

### フィロタキシス採用の理由

1. **自然の美しさ**: 植物の葉序に見られる自然で有機的な配置パターン
2. **重複回避**: 黄金角の特性により、アイデア間の重複が自然に回避される
3. **効率的な空間利用**: 螺旋配置により限られた空間を効率的に活用
4. **数学的一貫性**: フィボナッチ数列と黄金比に基づく数学的美しさ
5. **予測可能性**: アルゴリズムが決定論的で、同じ入力に対して同じ結果
6. **スケーラビリティ**: アイデア数の増加に対して線形的に対応

### 実装アルゴリズム

```typescript
// 黄金角の定数定義
const GOLDEN_ANGLE = 137.5077640500378; // 度

// フィロタキシス位置計算
function calculatePhyllotaxisPosition(
  index: number, 
  config: PhyllotaxisConfig
): Position {
  // 角度計算（黄金角 × インデックス）
  const angle = index * GOLDEN_ANGLE * (Math.PI / 180);
  
  // 半径計算（平方根による螺旋の密度調整）
  const radius = Math.sqrt(index) * config.radiusScale + config.minRadius;
  
  // 極座標から直交座標への変換
  return {
    x: config.centerX + radius * Math.cos(angle),
    y: config.centerY + radius * Math.sin(angle),
    angle: angle * (180 / Math.PI), // 度に変換
    radius: radius
  };
}
```

### 黄金角の特性

- **値**: 137.5077640500378° ≈ 137.51°
- **計算**: 360° × (1 - 1/φ) where φ = (1 + √5)/2 ≈ 1.618
- **特徴**: この角度により、連続する要素が重複しにくい最適な配置が実現

## 代替案

### グリッド配置
**利点:**
- 実装が簡単
- 予測しやすい配置
- 整然とした見た目

**欠点:**
- 機械的で無機質な印象
- 空間利用効率が悪い
- 創造性を刺激しない

### ランダム配置
**利点:**
- 実装が簡単
- 毎回異なる配置

**欠点:**
- 重複や偏りが発生しやすい
- 再現性がない
- 美的価値が低い

### 力学シミュレーション（Force-directed layout）
**利点:**
- 動的で自然な配置
- ノード間の関係を表現可能

**欠点:**
- 計算コストが高い
- 収束に時間がかかる
- 予測困難な配置

### 六角格子配置
**利点:**
- 効率的な空間利用
- 蜂の巣のような自然な美しさ

**欠点:**
- 固定的な配置パターン
- 有機的な成長感が不足

## 影響

### 正の影響

1. **視覚的魅力**: 自然で美しい螺旋パターンによる視覚的満足度
2. **ユーザー体験**: 思考の有機的な成長を視覚化
3. **空間効率**: 限られた画面空間の効率的な活用
4. **パフォーマンス**: O(1)の計算複雑度による高速処理
5. **教育的価値**: フィロタキシスの科学的背景による学習効果

### 負の影響

1. **学習コスト**: 開発者がフィロタキシスの概念を理解する必要
2. **カスタマイズ制限**: 配置パターンの変更が困難
3. **デバッグ複雑性**: 数学的計算のデバッグが必要

### 技術的制約

1. **浮動小数点精度**: JavaScript の浮動小数点演算による微小な誤差
2. **画面サイズ依存**: 異なる画面サイズでの配置調整が必要
3. **アニメーション考慮**: 配置変更時のアニメーション設計

### パフォーマンス特性

```typescript
// 計算複雑度: O(1) - 各アイデアの位置計算は独立
// 空間複雑度: O(n) - n個のアイデアの位置情報を保存
// 更新コスト: O(1) - 新しいアイデア追加時の計算コスト

// パフォーマンス最適化
const memoizedPositions = useMemo(() => {
  return ideas.map((_, index) => 
    calculatePhyllotaxisPosition(index, config)
  );
}, [ideas.length, config]);
```

### 設定パラメータ

```typescript
interface PhyllotaxisConfig {
  goldenAngle: 137.5077640500378;  // 黄金角（固定）
  radiusScale: 20;                 // 半径スケール係数
  centerX: 400;                    // SVG中心X座標
  centerY: 300;                    // SVG中心Y座標
  minRadius: 60;                   // 最小半径（中心テーマとの距離）
}
```

## 関連文書

- [フィロタキシスの数学的背景](https://en.wikipedia.org/wiki/Phyllotaxis)
- [黄金角と黄金比](https://en.wikipedia.org/wiki/Golden_angle)
- [設計書: フィロタキシス実装詳細](../design.md#フィロタキシス実装詳細)
- [Fibonacci Spirals in Nature](https://www.mathsisfun.com/numbers/nature-golden-ratio-fibonacci.html)