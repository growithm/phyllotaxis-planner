# ADR-0006: ECSシステム統合テスト戦略

## ステータス

承認済み

## 日付

2025-02-08

## コンテキスト

Phyllotaxis PlannerのECSアーキテクチャにおいて、3つの主要システム（PhyllotaxisSystem、AnimationSystem、RenderSystem）の統合動作を検証する包括的なテスト戦略が必要でした。

### 課題
- 複数システム間の実行順序とイベント連携の検証
- 数学的計算からSVG描画までの精度保証
- パフォーマンス要件（60FPS維持）の検証
- 大量エンティティでの安定動作の確認
- テストコードの保守性と再利用性

### 要件
- システム実行順序の検証（優先度ベース）
- イベント駆動による連携の検証
- フィロタキシス計算精度の検証
- SVG描画の正確性検証
- パフォーマンス基準の検証（10エンティティ < 16ms）
- エラーハンドリングの検証

## 決定

### テスト構造の分離
1. **統合テスト** (`tests/integration/`): 機能統合の検証
2. **パフォーマンステスト** (`tests/performance/`): 性能要件の検証
3. **共通ヘルパー** (`tests/shared/helpers/ecs-helpers/`): 機能別分割

### テストヘルパーの機能分割
```
tests/shared/helpers/ecs-helpers/
├── world-helpers.ts      # World関連
├── system-helpers.ts     # システム管理
├── entity-helpers.ts     # エンティティ操作
├── svg-helpers.ts        # SVG描画
├── event-helpers.ts      # イベント処理
└── index.ts             # 統合エクスポート
```

### テスト分類
1. **ECSシステム統合テスト**
   - システム実行順序の検証
   - イベント連携の検証
   - エラーハンドリングの検証

2. **フィロタキシス描画統合テスト**
   - 数学的計算の精度検証
   - ECS統合での計算一致性
   - SVG描画の正確性検証

3. **パフォーマンステスト**
   - 単一フレーム処理性能
   - 継続実行性能
   - スケーラビリティ検証

### テスト実行スクリプト
```json
{
  "test:integration": "vitest tests/integration",
  "test:performance": "vitest tests/performance", 
  "test:all": "vitest && vitest tests/integration && vitest tests/performance"
}
```

## 理由

### 1. テスト構造の分離
- **関心の分離**: 機能テストと性能テストを明確に分離
- **実行効率**: 開発時は統合テストのみ、リリース前は全テスト実行
- **保守性**: 各テストカテゴリの独立した保守が可能

### 2. ヘルパーの機能分割
- **再利用性**: 機能別に分割することで必要な部分のみインポート可能
- **可読性**: 責務が明確で理解しやすい
- **拡張性**: 新機能追加時に適切なヘルパーファイルに追加可能

### 3. 包括的なテストカバレッジ
- **システム統合**: 3システムの連携動作を完全検証
- **数学的精度**: フィロタキシス計算の正確性を保証
- **視覚的品質**: SVG描画の精度を検証
- **性能保証**: 60FPS維持の要件を検証

### 4. イベント駆動テスト
- **非同期処理**: イベントベースの連携を適切にテスト
- **順序検証**: システム間のイベント発火順序を検証
- **エラー処理**: イベント処理エラーの影響範囲を検証

## 代替案

### A. 単一の大きなテストファイル
- **却下理由**: 保守性が低く、テスト実行時間が長い
- **問題**: 特定の機能のみテストしたい場合に非効率

### B. システム別の個別テスト
- **却下理由**: システム間の統合動作を検証できない
- **問題**: 実際の使用パターンでの動作保証ができない

### C. モックを多用したテスト
- **却下理由**: 実際の統合動作を検証できない
- **問題**: モックと実装の乖離リスク

## 影響

### 正の影響
1. **品質保証**: システム統合の動作が包括的に検証される
2. **開発効率**: 問題の早期発見により開発サイクルが改善
3. **保守性**: 機能別ヘルパーにより保守コストが削減
4. **性能保証**: パフォーマンス要件が継続的に検証される
5. **回帰防止**: 変更による既存機能への影響を早期検出

### 考慮事項
1. **テスト実行時間**: 統合テストは単体テストより時間がかかる
2. **環境依存**: JSDOMやSVG要素の制約
3. **保守コスト**: テストヘルパーの保守が必要

### リスク軽減策
1. **並列実行**: Vitestの並列実行機能を活用
2. **選択実行**: 開発時は必要なテストのみ実行
3. **継続的改善**: テスト結果に基づくヘルパーの改善

## 実装詳細

### テストファイル構成
```
tests/
├── integration/
│   ├── ecs-systems/
│   │   ├── main-systems-integration.test.ts
│   │   └── system-execution-order.test.ts
│   └── phyllotaxis-rendering/
│       └── phyllotaxis-calculation-to-svg.test.ts
├── performance/
│   └── ecs-performance/
│       └── main-systems-performance.test.ts
└── shared/
    ├── helpers/ecs-helpers/
    └── fixtures/ecs-data/
```

### 検証項目
1. **システム実行順序**: 優先度ベース実行の検証
2. **イベント連携**: POSITION_CALCULATED → ANIMATION_START → RENDER_COMPLETED
3. **数学的精度**: 黄金角137.5°による位置計算の正確性
4. **SVG描画**: transform属性の正確な設定
5. **パフォーマンス**: 10エンティティ < 16ms（60FPS維持）
6. **エラー処理**: 一部システムエラーでも他システム継続動作

## 関連文書

- [ADR-0004: ECSアーキテクチャ採用の決定記録](./0004-ecs-architecture-adoption.md)
- [ADR-0005: イベント駆動アーキテクチャ採用の決定記録](./0005-event-driven-architecture-adoption.md)
- [テスト戦略・設計書](../tests/README.md)
- [ECSシステム設計文書](../architecture/ecs/systems.md)

## 今後の改善計画

1. **Phase 1**: ビジュアルリグレッションテストの追加
2. **Phase 2**: E2Eテストとの統合
3. **Phase 3**: パフォーマンス監視の自動化
4. **Phase 4**: テストデータ生成の自動化